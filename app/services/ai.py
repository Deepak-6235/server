import os
import requests
from PIL import Image
from google import genai
from google.genai import types
from app.core.config import GEMINI_API_KEY
from app.services.prompts.Images import get_image_generation_config
from app.services.prompts.video import get_image_generation_config as get_video_generation_config
from app.services.s3 import upload_video_bytes_to_s3

client = genai.Client(api_key=GEMINI_API_KEY)


def analyze_and_generate_views(image_path: str, product_name: str, upload_dir: str):
    img = Image.open(image_path)

    model_id = "gemini-2.5-flash-image"

    prompt, angles = get_image_generation_config(product_name)

    # Keep regenerating until we get exactly 6 images
    while True:
        response = client.models.generate_content(
            model=model_id,
            contents=[prompt, img],
            config=types.GenerateContentConfig(
                response_modalities=["TEXT", "IMAGE"], 
                candidate_count=1
            )
        )

        views = {}
        image_count = 0

        if response.candidates and response.candidates[0].content.parts:
            for part in response.candidates[0].content.parts:
                if part.inline_data:
                    if image_count < 6:
                        angle = angles[image_count]
                        filename = f"nano_{angle}_{os.path.basename(image_path)}"
                        save_path = os.path.join(upload_dir, filename)
                        
                        with open(save_path, "wb") as f:
                            f.write(part.inline_data.data)
                        
                        views[angle] = filename
                        image_count += 1
        
        # If we got exactly 6 images, break the loop and return
        if image_count == 6:
            break
    
    return {
        "views": views,
        "analysis": {"status": "Generated by Gemini Image"}
    }


def analyze_and_generate_video(image_path: str, product_name: str, upload_dir: str):
    import time

    img = Image.open(image_path)

    prompt = get_video_generation_config(product_name)

    # Use Veo 3.1 for video generation
    operation = client.models.generate_videos(
        model="veo-3.1-generate-preview",
        prompt=prompt,
        # Note: Veo currently doesn't support reference images directly in the prompt
        # The image will be described in the prompt text
    )

    # Poll until video generation is complete
    while not operation.done:
        print("Waiting for video generation to complete...")
        time.sleep(10)
        operation = client.operations.get(operation)

    video_url = None

    # Extract the generated video from the operation response
    if operation.response and hasattr(operation.response, 'generated_videos'):
        if len(operation.response.generated_videos) > 0:
            generated_video = operation.response.generated_videos[0]

            # Get video URL or download it
            video_uri = None
            if hasattr(generated_video.video, 'uri'):
                video_uri = generated_video.video.uri
            elif hasattr(generated_video.video, 'url'):
                video_uri = generated_video.video.url

            if video_uri:
                # Download video from Veo's URL
                print(f"Downloading video from: {video_uri}")
                response = requests.get(video_uri)
                response.raise_for_status()
                video_bytes = response.content

                # Generate S3 key
                filename = f"videos/video_{os.path.basename(image_path).split('.')[0]}_{int(time.time())}.mp4"

                # Upload to S3
                print("Uploading video to S3...")
                video_url = upload_video_bytes_to_s3(video_bytes, filename)
                print(f"Video uploaded successfully: {video_url}")

    return {
        "video": video_url,
        "analysis": {"status": "Generated by Veo 3.1"}
    }

    