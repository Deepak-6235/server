# from google import genai
# from google.genai import types
# from PIL import Image
# import os
# from app.core.config import GEMINI_API_KEY

# client = genai.Client(api_key=GEMINI_API_KEY)


# def analyze_and_generate_views(image_path: str, product_name: str, upload_dir: str):
#     # 1. Load the original image you sent from the frontend
#     img = Image.open(image_path)

#     # 2. Call the image-to-image capable model
#     model_id = "gemini-2.5-flash-image" 

#     prompt = f"""
#     Reference Product: {product_name}
#     Action: Using the provided image, generate 4 new high-quality images.
#     Angles: 1. Front View, 2. Back View, 3. Left Side, 4. Right Side.
#     Requirements: Maintain 100% color and texture consistency. Use a flat 2D style.
#     Output: Return 4 image parts.
#     """

#     # 3. CRITICAL: Set response_modalities to ["IMAGE"]
#     response = client.models.generate_content(
#         model=model_id,
#         contents=[prompt, img],
#         config=types.GenerateContentConfig(
#             response_modalities=["IMAGE"]
#         )
#     )

#     views = {}
#     angles = ["front", "back", "left", "right"]
#     image_count = 0

#     # 4. Catch the images coming back from Nano Banana
#     for part in response.candidates[0].content.parts:
#         if part.inline_data and image_count < 4:
#             angle = angles[image_count]
#             filename = f"nano_{angle}_{os.path.basename(image_path)}"
#             save_path = os.path.join(upload_dir, filename)
            
#             # Save the raw bytes directly to your project's upload folder
#             with open(save_path, "wb") as f:
#                 f.write(part.inline_data.data)
            
#             views[angle] = filename
#             image_count += 1

#     return {
#         "views": views,
#         "analysis": {"status": "Generated by Nano Banana"}
#     }





from openai import OpenAI
from PIL import Image
import os
import base64
from app.core.config import OPENAI_API_KEY

client = OpenAI(api_key=OPENAI_API_KEY)


def analyze_and_generate_views(image_path: str, product_name: str, upload_dir: str):
    os.makedirs(upload_dir, exist_ok=True)

    prompt = f"""
    Reference Product: {product_name}

    Task:
    Using the provided product image, generate 4 high-quality product images.

    Views:
    1. Front view
    2. Back view
    3. Left side view
    4. Right side view

    Rules:
    - Maintain 100% color, material, and texture consistency
    - Flat 2D e-commerce style
    - No background distractions
    - Same lighting and proportions
    """

    views = {}
    angles = ["front", "back", "left", "right"]

    with open(image_path, "rb") as img_file:
        original_image = img_file.read()

    for angle in angles:
        angle_prompt = f"{prompt}\nGenerate ONLY the {angle} view."

        result = client.images.generate(
            model="gpt-image-1",
            prompt=angle_prompt,
            image=original_image,
            size="1024x1024"
        )

        image_base64 = result.data[0].b64_json
        image_bytes = base64.b64decode(image_base64)

        filename = f"openai_{angle}_{os.path.basename(image_path)}"
        save_path = os.path.join(upload_dir, filename)

        with open(save_path, "wb") as f:
            f.write(image_bytes)

        views[angle] = filename

    return {
        "views": views,
        "analysis": {
            "status": "Generated by OpenAI gpt-image-1"
        }
    }
